Disclaimer: This documentation is a work-in-progress. However, it reflects the latest state of Lens development and provides documentation for the new [0.2.x](https://github.com/elifesciences/lens/tree/0.2.x) series of Lens. You can contribute to this manual by making changes to the source [markdown file](https://github.com/elifesciences/lens-manual/blob/master/manual.md).

# Intro

eLife Lens provides a novel way of looking at content on the web. It is designed to make life easier for researchers, reviewers, authors and readers. For example, have you tried to look at a figure in an online article, while at the same time trying to see what the author says about the figure, jumping all around the article, losing track of what you were looking for in the first place? The reason for this is that most online research articles are published in a fixed digital version of the original paper. With eLife Lens, we take full advantage of the internetâ€™s flexibility.

# Installation

## Prerequisites

- Node.js >=0.8.x
- [Pandoc](http://johnmacfarlane.net/pandoc/installing.html) >= 1.11.x (for on-the-fly generation of the Lens manual from Markdown)

Node.js is just used a development enviroment. You'll soon be able to create self-contained packages of the individual modules or the main app itself.

## Fresh install

### Install the Substance Screwdriver command line utility. 

It's just a little helper that hels you deal with our many modules.

    $ git clone https://github.com/substance/screwdriver.git
    $ cd screwdriver
    $ sudo python setup.py install


### Clone the Lens Mothership

    $ git clone https://github.com/elifesciences/lens.git
  
### Run the update command, which pulls in all the sub-modules and dependencies

    $ cd lens
    $ substance --update
  
### Finally start the server

    $ substance

You can have a look at the example document, by pointing your browser to `http://localhost:4000/#lorem_ipsum`, view the autogenerated Lens.Article documentation here `http://localhost:4000/#lens_article` or the manual `http://localhost:4000/#manual`.
   
## Keep your local version in sync

You may want to pull in updates every now and then, which is simple. In the Lens project root dir do:

    $ substance --update
   
And start the dev environment again.

    $ substance

# Contributing

I'm assuming here that you have push access to the repositories, because as a start I'd like to get the Lens core dev team up and running. I'll provide documentation on how to work with a forked version of a module and submit a pull request soon.


Say you've made changes to the Lens.Article module. In order to commit them you simply have to navigate to `node_modules/lens-article` and do:

    $ git add <YOUR STUFF>
    $ git commit -m "Fixed X"
    $ git push
   
Alternatively, if you are working on breaking changes you can switch to a different branch, and submit a pull request using the Github interace. Here's how:

    $ git checkout -b my_feature_branch
    $ git add <YOUR STUFF>
    $ git commit -m "Fixed X"
    $ git push

Then go to [Github](http://github.com) and submit a pull request.


Another hint: To pull in upstream changes from master for the entire project do this:

    $ substance --git -- pull origin master:<feature_branch_name>


## Adjusting styles

Most customization can be done with CSS without interfering with the Lens codebase. You only override styles on the application level.

Say you'd like to like to color citation cards red.

    #my_app .article .citations .resourece-header {
      background: red;
    }

You've got the idea. Now it's on you. It should be easy to pull in changes from the official Lens modules, without breaking your app.

## Implement a new node type

It doesn't take much to implement a new node type for Lens. However think carefully if there isn't an existing type that fits your need. We'd prefer that you adjust existing types and contribute back. If we'd all figure out a way to find common ground in our scientific language that would be awesome. :)

Anyways, let's create a new node type. Only for demoing purposes let's create a `cat` node type that you can reference in the main body of the document. So first thing to do is creating a new folder in the `lens-article` repository  `/nodes/cat`. Structure of that folder will be like this:

    index.js
    cat.js
    cat_view.js
    cat.css

Let's start with specifying the type definitions in `cat.js`. You cat 

    var _ = require('underscore');
    var Node = require('../node');


    var Cat = function(node, doc) {
      Node.call(this, node, doc);
    };

    // Type definition
    // -----------------
    //

    Cat.type = {
      "id": "cat",
      "parent": "figure",
      "properties": {
        "name": "string",
        "speed": "string",
        "abilities": ["array", "string"],
      }
    };

    Cat.prototype = Node.prototype
    Cat.prototype.constructor = Cat;


    // Auto-generate property getters based on the type definition 
    // --------

    var getters = {};

    _.each(Cat.type.properties, function(prop, key) {
      getters[key] = {
        get: function() {
          return this.properties[key];
        }
      };
    });


    Object.defineProperties(Cat.prototype, _.extend(getters, {
      caption: {
        // Used for 
        heading: function() {
          return this.properties.
        }
      }
    }));

    module.exports = Cat;


That was easy. Now we need to implement a view for the `Cat` model we just defined. Here `cat_view.js`.


    var NodeView = require("../node").View;

    var CatView = function(node) {
      NodeView.call(this, node);

      this.$el.attr({id: node.id});
      this.$el.addClass("content-node cat");
    };

    CatView.Prototype = function() {

      this.render = function() {
        NodeView.prototype.render.call(this);
        var node = this.node;

        var html = [
          '<div class="name">'+this.cat+'</div>'
          '<div class="speed">'+this.speed+'</div>'
          '<div class="abilities">'+this.abilities.join(', ')+'</div>'
        ].join('\n');

        this.content.innerHTML = html;

        return this;
      }
    };

    // CatView inherits from NodeView
    CatView.Prototype.prototype = NodeView.prototype;
    CatView.prototype = new CatView.Prototype();

    module.exports = CatView;

Add some styles in `cat.css`:

    .content-node.cat .name {
      font-size: 20px;
      color: green;
    }

By convention there needs to be an `index.js` file in the repo.

    var Cat = require('./cat');
    Cat.View = require('./cat_view');
    module.exports = Cat;


Finally you have to register your new node type in `nodes/index.js`.

    module.exports = {
      ...
      "cat": require("./cat"),
      ...
    };


Now in your actual document, you can specify and reference `cat` resources. It looks like so:

    {
      id: "example_doc",
      "nodes": {
        ...
        "oliver": {
          "id": "oliver"
          "type": "cat",
          "name": "Oliver",
          "abilities": ["jump high", "eat much", "bite", "hunt mice"],
        },
        "paragraph_1": {
          "id": "paragraph_1",
          "type": "paragraph",
          "content": "Last sunday I had much fun with Oliver the cat."
        },
        "figure_reference_oliver": {
          "id":"figure_reference_oliver",
          "type":"figure_reference",
          "path": ["paragraph_3", "content"],
          "target": "oliver",
          "range":[31,37]
        },
        ...
      }
    }
